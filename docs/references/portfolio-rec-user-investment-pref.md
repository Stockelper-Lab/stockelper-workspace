# 작업 개요

- 사용자 투자 성향 기반 포트폴리오 추천 기능 개발
- 포트폴리오 상품: 국내 개별 주식 (etf 제외)

# 포트폴리오 매수 워크플로우

## 입력 스키마

- **max_portfolio_size**: 포트폴리오에 포함할 최대 종목 수 (기본값: 10)
- **risk_free_rate**: 무위험 이자율, 연율 기준 (기본값: 0.03 = 3%)
- **rank_weight**: 각 순위 지표의 가중치 설정 (기본값: 모두 0.0)
    - **operating_profit**: 영업이익 순위 가중치 - 영업이익이 높은 종목을 선호하는 정도 (수익자산지표 기준)
    - **net_income**: 당기순이익 순위 가중치 - 당기순이익이 높은 종목을 선호하는 정도 (수익자산지표 기준)
    - **total_liabilities**: 부채총계 순위 가중치 - 부채 규모를 고려하는 정도 (수익자산지표 기준)
    - **rise_rate**: 상승률 순위 가중치 - 최근 주가 상승률이 높은 종목을 선호하는 정도 (등락률 기준)
    - **fall_rate**: 하락률 순위 가중치 - 최근 주가 하락률을 고려하는 정도, 저점 매수 전략에 활용 가능 (등락률 기준)
    - **profitability**: 수익성 분석 순위 가중치 - 수익성 지표가 우수한 종목을 선호하는 정도 (ROE, ROA 등 재무비율 기준)
    - **stability**: 안정성 분석 순위 가중치 - 재무 안정성이 높은 종목을 선호하는 정도 (유동비율, 부채비율 등 재무비율 기준)
    - **growth**: 성장성 분석 순위 가중치 - 매출·이익 성장률이 높은 종목을 선호하는 정도 (성장률 지표 재무비율 기준)
    - **activity**: 활동성 분석 순위 가중치 - 자산 활용 효율이 높은 종목을 선호하는 정도 (총자산회전율 등 재무비율 기준)
    - **volume**: 거래량 순위 가중치 - 거래량이 많아 유동성이 높은 종목을 선호하는 정도 (일일 거래량 기준)
    - **market_cap**: 시가총액 순위 가중치 - 시가총액이 큰 대형주를 선호하는 정도 (시가총액 기준)

## 노드

### 1. Ranking

다양한 순위 지표를 기반으로 포트폴리오에 포함할 종목을 선정합니다.

- 11가지 순위 함수를 사용하여 종목 평가 (영업이익, 당기순이익, 부채총계, 상승률, 하락률, 수익성, 안정성, 성장성, 활동성, 거래량, 시가총액)
- 각 순위에 대해 가중치를 적용하여 종합 점수 계산
- 정규화된 순위 점수 = (n - rank + 1) / (n * (n + 1) / 2) × 가중치
- 종합 점수가 높은 상위 N개 종목을 포트폴리오 후보로 선정 (기본값: 10개)
- 각 종목의 순위 점수를 state에 저장하여 추후 포트폴리오 가중치 계산에 활용
- 출력: portfolio_list (선정된 종목 리스트), stock_scores (종목별 점수)

### 2. WebSearch

웹 검색을 통해 종목의 최신 뉴스, 재무 실적, 투자 전망, 리스크 요인, 산업 동향을 분석합니다.

- Perplexity AI 모델을 사용하여 실시간 웹 검색 수행
- 각 종목에 대해 최근 뉴스, 재무 실적, 투자 전망, 주요 리스크 요인, 산업 동향을 종합적으로 분석
- 모든 종목에 대해 병렬로 분석을 수행하여 처리 속도 최적화
- 각 종목당 하나의 비동기 태스크로 실행
- 에러가 발생한 종목은 경고 로그 출력 후 건너뜀
- 출력: analysis_results (type="web_search")

### 3. FinancialStatement

DART API를 활용하여 재무제표 데이터를 조회하고 주요 재무 지표를 계산합니다.

- OpenDartReader를 사용하여 최근 5년 내 재무제표 데이터 조회
- 8가지 주요 재무 지표 계산:
    - 유동비율 (유동자산 / 유동부채 × 100)
    - 부채비율 (부채총계 / 자본총계 × 100)
    - 유보율 ((자본잉여금 + 이익잉여금) / 납입자본금 × 100)
    - 자본잠식률 ((자본금 - 자본총계) / 자본금 × 100)
    - 경상이익 (영업이익 + 영업외수익 - 영업외비용)
    - 매출액경상이익률 (경상이익 / 매출액 × 100)
    - 이자보상배율 (영업이익 / 이자비용 × 100)
    - 자기자본이익률 (당기순이익 / 자본총액 × 100)
- 모든 종목에 대해 병렬로 분석 수행 (asyncio.to_thread 사용)
- 출력: analysis_results (type="financial_statement")

### 4. TechnicalIndicator

한국투자증권 API를 통해 180일간의 주가 데이터를 조회하고 기술적 지표를 계산합니다.

- mojito 라이브러리를 사용하여 일봉 데이터 조회 (최근 180일)
- 다양한 기술적 지표 계산:
    - MACD (12일/26일 지수이동평균 차이 및 9일 시그널)
    - 볼린저 밴드 (20일 이동평균 ± 2 표준편차)
    - RSI (14일 상대강도지수)
    - 스토캐스틱 (K=14일, D=3일)
    - 이동평균선 (20일/60일/120일)
    - 현재가, 거래량
- API Rate Limit 준수를 위해 배치 단위로 처리 (초당 최대 20건, 환경변수로 설정 가능)
- 출력: analysis_results (type="technical_indicator")

### 5. ViewGenerator

3가지 분석 결과(웹 검색, 재무제표, 기술적 지표)를 종합하여 각 종목에 대한 투자 의견을 생성합니다.

- LLM을 사용하여 세 가지 분석 결과를 종합 평가
- 각 종목별로 InvestorView 생성:
    - expected_return: 향후 1년간 예상 초과 수익률 (-0.20 ~ 0.20, -20% ~ 20%)
    - confidence: 예측 신뢰도 (0.0 ~ 1.0, 세 분석의 일치도에 따라 결정)
    - reasoning: 투자 판단 근거 (2-3문장의 간결한 설명)
- 분석 데이터가 부족한 종목은 중립적 뷰 반환 (expected_return=0.0, confidence=0.3)
- 수익률 및 신뢰도 가이드라인을 제공하여 일관된 평가 유도
- 출력: investor_views (종목별 투자 의견 리스트)

### 6. PortfolioBuilder

Black-Litterman 모델을 사용하여 최적 포트폴리오를 구성합니다.

- Black-Litterman 알고리즘 기반 포트폴리오 최적화:
    1. 수익률 공분산 행렬 계산 (일별 수익률을 연율화)
    2. 순위 점수 기반 시장 균형 가중치 계산
    3. 위험 회피 계수 계산 (시장 프리미엄 6% 가정)
    4. 시장 균형 초과 수익률 계산 (pi = delta × Sigma × w_mkt)
    5. 투자자 뷰 행렬 구성 (P, Q, Omega)
    6. Black-Litterman 사후 수익률 계산
    7. 최적 포트폴리오 가중치 계산 (SLSQP 최적화)
- 제약 조건: 가중치 합 = 1, 개별 종목 비중 0% ~ 30%
- 포트폴리오 성과 지표 계산:
    - expected_return: 연간 예상 수익률
    - volatility: 연간 변동성 (표준편차)
    - sharpe_ratio: 샤프 비율 (초과수익률 / 변동성)
- 각 종목의 비중에 ViewGenerator에서 생성한 reasoning 매핑
- 비중이 0.1% 미만인 종목은 제외
- 출력: portfolio_result (최적 포트폴리오 비중 및 성과 지표)

### 7. PortfolioTrader

PortfolioBuilder에서 생성한 포트폴리오의 종목들을 비율에 맞게 매수합니다

- 계좌 잔고 조회
- 포트폴리오 각 종목의 현재가 조회
- 포트폴리오 비율에 맞게 매수 수량 계산 및 매수 주문

## 결과물

```
============================================================
포트폴리오 분석 결과
============================================================

[종목 구성]

1. 바이오노트 (377740) - 13.6%
   바이오노트는 최근 수익성 개선과 매출 증가가 확연하며, 강력 매수 신호와 안정적인 재무 구조를 보이고 있습니다. 기술적 지표 또한 긍정적이며, 백신과 체외진단 시장의 성장 기대감이 투자 매력을 높입니다. 다만, 경쟁 심화 및 매출 변동성 리스크가 존재하므로 중장기 리스크 관리가 필요합니다.

2. LX홀딩스 (383800) - 12.7%
   웹 검색 분석에서 자회사 실적 개선과 자산 확장, 저평가 상태 및 안정적 배당이 긍정적으로 평가됩니다. 재무제표 주요 지표는 안정적이며 부채비율이 매우 낮아 재무 건전성이 높습니다. 다만, 기술적 지표가 중립권에 머무르고 산업 및 글로벌 리스크가 존재해 강세지만 다소 신중한 접근이 필요합니다.

3. 대성창투 (027830) - 11.8%
   대성창투는 벤처투자 시장 회복 기대와 저평가 상태가 긍정적이지만, 최근 실적 부진과 그룹 내 리스크로 단기적 불확실성이 존재합니다. 기술적 지표는 과매도 구간을 시사하나 거래량과 변동성이 커 신중한 접근이 필요합니다.

4. SK스퀘어 (402340) - 11.0%
   SK스퀘어는 2025년 3분기 호실적과 SK하이닉스 지분 가치 상승에 따른 안정적 수익성이 돋보이며, 기술적 지표도 긍정적 추세를 유지합니다. 다만, 높은 부채비율과 글로벌 반도체 시장 변동성, 외국인·기관 매도세 등 단기 리스크가 존재해 중장기 성장 기대와 단기 변동성 사이 균형 잡힌 판단이 요구됩니다.

5. 한화에어로스페이스 (012450) - 11.1%
   최근 실적과 수주 잔고 호조, 증권사들의 목표주가 상향이 강한 긍정 신호이며 방산 부문 고마진과 수출 확대가 성장 동력이다. 다만, 재무제표의 부채비율 이상 수치와 자기자본이익률 제로, 그리고 기술적 지표의 중립 내지 약세 신호가 단기 조정 가능성을 시사한다. 전반적으로 중장기 성장 기대가 우세하나 단기 변동성 리스크를 감안해 강세 의견을 제시한다.

6. 알테오젠 (196170) - 10.7%
   알테오젠은 코스피 이전 상장과 강력한 실적 성장, FDA 승인 제품 마일스톤 수입 등의 긍정적 모멘텀으로 20% 이상의 상승 여력이 기대됩니다. 재무제표는 안정적 유동성과 낮은 부채비율을 보이나 높아진 밸류에이션과 자본잠식률 부정적 요인이 존재합니다. 기술적 지표는 강한 상승 추세를 시사하여 전반적으로 강세 의견을 유지하나 밸류에이션 부담으로 신뢰도를 약간 제한합니다.

7. 우리기술투자 (041190) - 8.0%
   우리기술투자는 가상자산 시장 호황과 신기술 금융 투자 확대에 힘입어 재무 실적이 급격히 개선되었으며, 밸류에이션도 저평가된 상태입니다. 다만, 단기 주가 변동성과 정책 리스크가 존재하고 기술적 지표도 과매도권 근처로 불안정하여 단기 변동성 관리가 필요합니다. 전반적으로 긍정적 성장 전망과 투자 매력으로 중장기 강세를 권고합니다.

8. 시프트업 (462870) - 7.6%
   웹 검색 분석은 시프트업의 강력한 실적과 우수한 수익성을 바탕으로 장기적 성장 가능성을 높게 평가하지만, 단기 모멘텀 부재와 차기작 출시 지연 리스크를 지적하고 있습니다. 재무제표 데이터 부재로 인해 구체적 재무 안정성 확인은 어렵지만, 기술적 지표는 RSI 40 수준과 스토캐스틱 저점권 진입 등 단기 조정 국면임을 시사합니다. 따라서 단기 조정 우려는 있으나 중장기적 관점에서 강세 의견을 유지합니다.

9. SK하이닉스 (000660) - 6.6%
   웹 검색에서 SK하이닉스가 견조한 실적과 AI 수요 확대에 힘입어 강세를 보이고 있으며, 재무제표상 부채비율은 높지만 유동비율과 이자보상배율이 안정적인 점이 긍정적입니다. 기술적 지표도 RSI가 과매수 구간은 아니지만 상승 모멘텀이 유지되고 있어 단기적으로 우호적인 환경입니다. 다만, 반도체 업황 둔화 가능성과 글로벌 리스크가 존재해 중장기 임팩트는 면밀히 모니터링 필요합니다.

10. 에이텍 (045660) - 6.8%
   재무제표는 견조한 수익성과 안정성을 보이나, 주가 변동성과 외부 이슈에 따른 단기 리스크가 존재합니다. 기술적 지표는 과매도 구간에서 반등 가능성을 시사하며, 장기적 성장 모멘텀은 AI 및 주력 사업에서 기대할 수 있습니다. 따라서 단기 변동성은 있으나, 중장기적 약한 강세 관점입니다.

[성과 지표]

예상 수익률: 8.87%
변동성: 27.56%
샤프 비율: 0.21

============================================================
```

![IMG_5515.jpeg](attachment:ba832f25-31da-4359-a4d2-0dfb5079fa0e:IMG_5515.jpeg)

# 포트폴리오 매도 워크플로우

## 입력 스키마

- **loss_threshold**: 손절 기준, 손실률이 이 값 이하일 경우 매도 대상으로 고려 (기본값: -0.10 = -10%)
- **profit_threshold**: 익절 기준, 수익률이 이 값 이상일 경우 매도 대상으로 고려 (기본값: 0.20 = 20%)

## 노드

### 1. GetPortfolioHoldings

계좌의 현재 보유 종목과 수익률 정보를 조회합니다.

- 한국투자증권 API를 통해 계좌 잔고 조회 (tr_id: VTTC8434R)
- 보유 수량이 0보다 큰 종목만 필터링
- 각 보유 종목에 대해 다음 정보 계산:
    - 종목코드 및 종목명
    - 보유 수량 (주)
    - 평균 매입가 (원)
    - 현재가 (원)
    - 수익률 (현재가 / 평균 매입가 - 1)
    - 평가 금액 (현재가 × 보유 수량)
    - 평가 손익 ((현재가 - 평균 매입가) × 보유 수량)
- API Rate Limit 준수를 위해 적절한 지연 시간 적용
- 출력: holding_stocks (보유 종목 리스트)

### 2. WebSearch

### 3. FinancialStatement

### 4. TechnicalIndicator

### 5. SellDecisionMaker

3가지 분석 결과(웹 검색, 재무제표, 기술적 지표)와 보유 종목의 수익률을 종합하여 매도 결정을 내립니다.

- LLM (GPT-4.1-mini)을 사용하여 종합적인 매도 판단 수행
- 각 보유 종목별로 다음 정보를 기반으로 분석:
    - 보유 수량, 평균 매입가, 현재가, 수익률, 평가 손익
    - 웹 검색 분석 결과 (최근 뉴스 및 시장 동향)
    - 재무제표 분석 결과
    - 기술적 지표 분석 결과
- 6가지 매도 기준을 고려:
    1. 손절: 손실률이 loss_threshold 이하인 경우
    2. 익절: 수익률이 profit_threshold 이상인 경우
    3. 펀더멘털 악화: 재무제표 지표가 크게 악화된 경우
    4. 기술적 지표 악화: 기술적 지표가 매도 신호를 보이는 경우
    5. 부정적 뉴스: 부정적인 뉴스나 리스크 요인이 있는 경우
    6. 산업 전망 악화: 산업 전망이 부정적인 경우
- 결정 가이드라인:
    - SELL: 위 기준 중 2개 이상 충족, 또는 1개 기준이 매우 명확하게 충족
    - HOLD: 위 기준 미충족, 또는 긍정적 요인이 부정적 요인보다 우세
- JsonOutputParser를 사용하여 구조화된 응답 파싱:
    - decision: "SELL" 또는 "HOLD"
    - reasoning: 결정 사유 (2-3문장의 간결한 설명)
- SELL 결정된 종목만 SellDecision 객체로 반환 (전체 매도만 가능)
- 출력: sell_decisions (매도 결정 리스트)

### 6. PortfolioSeller

SellDecisionMaker에서 결정한 종목들을 전량 매도합니다.

- 매도 결정된 종목의 보유 수량을 holding_stocks에서 조회
- 각 종목에 대해 시장가 매도 주문 실행:
    - 한국투자증권 API 사용 (tr_id: VTTC0801U)
    - 주문 구분: 시장가 매도 (ORD_DVSN="01")
    - 주문 수량: 보유 수량 전체 (전량 매도)
    - 주문 가격: 0 (시장가)
- API Rate Limit 준수를 위해 초당 최대 요청 수 제한 (KIS_MAX_REQUESTS_PER_SECOND)
- 각 주문 결과 기록:
    - 종목 정보 (코드, 이름)
    - 주문 수량 및 가격
    - 실행 상태 (success/failed)
    - 메시지 (성공/실패 사유)
- 매도 실행 결과 요약:
    - 총 평가 금액 (모든 보유 종목의 평가 금액 합계)
    - 실제 매도 금액 (매도 주문이 성공한 종목들의 평가 금액 합계)
- 출력: sell_result (매도 주문 실행 결과)

## 결과물

```
============================================================
매도 분석 결과
============================================================

[보유 종목]

1. SK하이닉스 (000660)
   보유 수량: 11주
   평균 매입가: 599,000원
   현재가: 544,000원
   수익률: -9.18%
   평가 손익: -605,000원

2. 한화에어로스페이스 (012450)
   보유 수량: 11주
   평균 매입가: 959,091원
   현재가: 895,000원
   수익률: -6.68%
   평가 손익: -705,000원

3. 대성창투 (027830)
   보유 수량: 7790주
   평균 매입가: 1,518원
   현재가: 1,605원
   수익률: 5.75%
   평가 손익: 679,650원

4. 우리기술투자 (041190)
   보유 수량: 960주
   평균 매입가: 8,338원
   현재가: 8,210원
   수익률: -1.53%
   평가 손익: -122,720원

5. 에이텍 (045660)
   보유 수량: 653주
   평균 매입가: 10,484원
   현재가: 11,050원
   수익률: 5.40%
   평가 손익: 369,850원

6. 알테오젠 (196170)
   보유 수량: 19주
   평균 매입가: 552,158원
   현재가: 456,500원
   수익률: -17.32%
   평가 손익: -1,817,500원

7. 바이오노트 (377740)
   보유 수량: 2411주
   평균 매입가: 5,631원
   현재가: 5,640원
   수익률: 0.17%
   평가 손익: 22,670원

8. LX홀딩스 (383800)
   보유 수량: 1551주
   평균 매입가: 8,198원
   현재가: 8,220원
   수익률: 0.27%
   평가 손익: 33,940원

9. SK스퀘어 (402340)
   보유 수량: 35주
   평균 매입가: 307,500원
   현재가: 302,000원
   수익률: -1.79%
   평가 손익: -192,500원

10. 시프트업 (462870)
   보유 수량: 201주
   평균 매입가: 37,754원
   현재가: 38,500원
   수익률: 1.97%
   평가 손익: 149,850원

[매도 결정]

1. 우리기술투자 (041190)
   사유: 종목은 수익률이 -1.53%로 손절 기준에 미치지 않으나, 재무제표에서 심각한 자본잠식률(73.23%)과 매우 높은 부채비율(1223.88%)을 보여 펀더멘털이 크게 악화된 상태입니다. 또한 기술적 지표 역시 MACD와 스토캐스틱 지표가 매도 신호를 보이고 있어 기술적 악화도 확인되므로, 이러한 두 가지 주요 기준에 의해 매도할 것을 권고합니다.

2. 알테오젠 (196170)
   사유: 수익률이 -17.32%로 손절 기준을 충족하고, 기술적 지표들이 RSI 25.86, MACD 음수 등 매도 신호를 명확히 보이고 있습니다. 또한 독일 특허 소송으로 인한 판매 금지 가처분 등 부정적 뉴스가 주가 변동성을 높여 단기 투자 리스크가 큽니다.

[매도 실행 결과]

총 평가 금액: 96,758,460원
매도 금액: 0원

주문 결과:
1. 우리기술투자 (041190): 960주 @ 8,210원 - 실패
   메시지: 모의투자 영업일이 아닙니다.
2. 알테오젠 (196170): 19주 @ 456,500원 - 실패
   메시지: 모의투자 영업일이 아닙니다.

============================================================
```